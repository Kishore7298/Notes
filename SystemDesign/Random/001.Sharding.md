# üß© System Design ‚Äî Sharding Explained

> **Speaker:** Evan (Former Meta Staff Engineer)
> **Topic:** Understanding sharding ‚Äî what it is, why it‚Äôs needed, how to design for it, and how to discuss it in interviews.

---

## 1. üìñ What is Sharding?

**Definition:**
Sharding is the process of splitting your data across multiple databases (shards) so that no single database holds all the data.

Each shard:

* Is an independent database
* Has its own CPU, memory, storage, and connection pool
* Stores a *subset* of the total data

**Goal:**
Increase storage, read, and write throughput by distributing load across multiple machines.

---

## 2. ‚öôÔ∏è Motivation ‚Äî Why Shard?

Start with one large DB (e.g., AWS RDS Postgres: 70TB, 10k writes/sec).

Growth leads to:

* Exceeding write or storage limits
* Slow queries and long backups

### Step 1: Vertical Scaling

Upgrade to a bigger instance (e.g., 140TB, 50k writes/sec)
‚úÖ Works temporarily
‚ùå Eventually hits hardware and I/O limits

### Step 2: Horizontal Scaling (Sharding)

Split the data across multiple databases.
Each shard handles a smaller portion of total data.
Scaling = add more shards.

---

## 3. üßÆ Key Decisions in Sharding

### Q1. What to Shard By?

‚Üí Choose a **shard key** (the column/attribute used to divide data).

### Q2. How to Distribute Data?

‚Üí Choose a **distribution strategy** (how values map to shards).

---

## 4. üéØ Choosing a Shard Key

### A good shard key has:

1. **High Cardinality:** Many unique values ‚Üí avoids clumping.
2. **Even Distribution:** Values spread evenly across shards.
3. **Query Alignment:** Aligns with common queries.

---

### ‚úÖ Good Examples

| Scenario     | Shard Key  | Why                                                                     |
| ------------ | ---------- | ----------------------------------------------------------------------- |
| Social Media | `user_id`  | High cardinality, even spread, query alignment (get all posts for user) |
| E-commerce   | `order_id` | High cardinality, well distributed, aligns with order lookups           |

---

### ‚ùå Bad Examples

| Example              | Problem                                                |
| -------------------- | ------------------------------------------------------ |
| `is_premium` boolean | Low cardinality ‚Üí only 2 shards possible               |
| `creation_date`      | Hotspot on latest shard (recent data heavily accessed) |

---

## 5. üóÇÔ∏è Distribution Strategies

### 1Ô∏è‚É£ Range-Based Sharding

* Divide data by range (`user_id: 0‚Äì10M`, `10M‚Äì20M`, etc.)
* ‚úÖ Simple, intuitive
* ‚ùå Causes hotspots (new users all go to latest shard)
* ‚ùå Empty shards early on

### 2Ô∏è‚É£ Hash-Based Sharding (‚≠ê Default)

* Apply a hash function to the shard key ‚Üí `hash(key) % N`
* ‚úÖ Uniform distribution
* ‚ùå Painful rebalancing when adding shards (modulus changes)

#### üåÄ Solution: Consistent Hashing

* Maps keys and shards onto a ring
* Reduces data movement when adding/removing shards
* Uses *virtual nodes* for smoother load balancing

‚úÖ **Industry Standard:**
**Hash-based sharding + Consistent Hashing**

---

### 3Ô∏è‚É£ Directory-Based Sharding

* Maintain a lookup table (`key ‚Üí shard mapping`)
* ‚úÖ High flexibility (e.g., move ‚Äúhot‚Äù users easily)
* ‚ùå Extra latency (two hops: directory + shard)
* ‚ùå Single point of failure

üß† **In interviews:** avoid using this unless asked about flexibility or dynamic rebalancing.

---

## 6. ‚ö° Common Sharding Challenges

---

### üß® 1. Hotspots / Load Imbalance

Some shards receive disproportionate traffic (e.g., ‚Äúcelebrity‚Äù users).

#### Solutions:

* **Compound Shard Key:** Add suffix/time factor ‚Üí `user_id + n`
* **Dedicated Shard:** Move high-traffic users (e.g., celebrities) to their own shard, use directory mapping.

---

### üîÄ 2. Cross-Shard Queries

When a query touches multiple shards (e.g., ‚ÄúTop 10 posts across all users‚Äù).

#### Solutions:

1. **Choose a better shard key** (align with queries)
2. **Cache results** (e.g., Redis, TTL few minutes)
3. **Denormalize data** (store duplicate info on same shard for frequent joins)

> ‚ö†Ô∏è Cross-shard queries should be **exceptions**, not the norm.

---

### ‚öñÔ∏è 3. Consistency Issues

#### Example:

* Bob (shard 1) sends $5 to Alice (shard 3)
* Cross-shard transaction ‚Üí no atomicity

#### Option A: **2-Phase Commit (2PC)**

* Central coordinator ensures all shards agree before commit
  ‚úÖ Ensures consistency
  ‚ùå Slow, fragile, blocking if coordinator fails

#### Option B: **Saga Pattern**

* Sequence of smaller transactions
* Each step has a compensating action if failure occurs
  ‚úÖ More resilient
  ‚úÖ Common in microservices
  ‚ùå Eventual consistency

#### Option C:

* Avoid cross-shard transactions when possible

---

## 7. üß© Key Takeaways for Interviews

‚úÖ **When to mention sharding:**
When scaling DB throughput/storage beyond single-node capacity.

‚úÖ **Say explicitly:**

* ‚ÄúWe‚Äôll shard by `<key>` using hash-based sharding with consistent hashing.‚Äù

‚úÖ **Anticipate interviewer questions:**

* How do you choose the shard key?
* How do you handle hotspots?
* How do you rebalance shards?
* How do you deal with cross-shard queries?
* How do you ensure consistency?

‚úÖ **Be ready to discuss:**

* Caching
* Denormalization
* Compound keys
* Saga pattern
* Trade-offs (latency, consistency, operational complexity)

---

## üß† TL;DR Summary

| Concept                 | Key Idea                              | Interview Tip                                  |
| ----------------------- | ------------------------------------- | ---------------------------------------------- |
| **Sharding**            | Split data across multiple DBs        | Mention when scaling limits hit                |
| **Shard Key**           | Attribute deciding data placement     | Must ensure high cardinality & query alignment |
| **Hash-Based Sharding** | Even distribution using hash(key) % N | Default approach                               |
| **Consistent Hashing**  | Smooth rebalancing on scaling         | Mention if interviewer probes deeper           |
| **Hotspots**            | Uneven traffic (celebrity problem)    | Fix via compound keys or celebrity shard       |
| **Cross-Shard Queries** | Expensive multi-shard reads           | Cache or denormalize                           |
| **Consistency**         | Atomic ops break across shards        | Mention Saga or 2PC patterns                   |

---